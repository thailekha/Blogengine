#{extends 'main.html' /}
#{set title:'Home page' /}
#{homenavigation /}
<section class="ui two column grid segment">
<div class="five wide column">
	<h1 class="ui blue header">${user.firstName + " " + user.lastName}'s home page</h1>
	<br>
	<div class="ui compact segment">
		<img src="/profilepicture/${user.id}" class="ui small image">
		<br><br>
		<a href="#">Following: ${user.followings.size()}</a>
		<br>
		<a href="#">Followers: ${user.followers.size()}</a>
	</div>
	#{blogform /}
	<div id="blogsshow" class="ui segment">
		<button onclick="showblogs()" class="ui button">Your blogs</button>
		<div id="blogssegment">
			#{if user.blogs.size() == 0}
				<h4>You don't have any blog</h4>
			#{/if}
			#{list items:user.blogs, as:'blog'}
				<br>
				<a class="ui blue header" href="/blog/${blog.id}">
				<i class="right triangle icon"></i>
					${blog.blogTitle}
				</a>
				<a href="/deleteblog/${blog.id}"><i class="red circle remove icon"></i></a>
			#{/list}
		</div>
	</div>
	<div id="othersshow" class="ui segment">
		<button onclick="showothers()" class="ui blue button">Bloggers</button>
		<div id="otherssegment">
			#{if others.size() == 0}
				<h4>There are no other bloggers yet</h4>
			#{/if}
			#{list items:others, as:'blogger'}
				<br>
				<a class="ui small blue header" href="#">${blogger.firstName + " " + blogger.lastName}  </a>
				%{
					followed = false;
				}%
				#{list items:blogger.followers, as:'follower'}
					#{if follower.source.equals(user)}
						%{
							followed = true;
						}%
					#{/if}
				#{/list}
				
				#{if followed}
					<a href="/unfollow/${blogger.id}">(unfollow)</a>
				#{/if}
				#{else}
					<a href="/follow/${blogger.id}">(follow)</a>
				#{/else}
			#{/list}
		</div>
	</div>
	
</div>	
<div class="ui ten wide column">
<button onclick="newsfeed()" class="ui button">Newsfeed</button>
<div  id="newsfeedboard" class="ui segment"></div>
<br><br>
</div>	
</section>

<script>
$('#blogssegment').hide();
var showblogs = function() {
	$('#blogssegment').toggle(500);
}
var showothers = function() {
	$('#otherssegment').toggle(500);
}

$('#blogsshow').hover(function(){
	$('#blogsshow').css("background-color", "#B8E6B8");
	}, function(){
	$('#blogsshow').css("background-color", "white");
});
$('#othersshow').hover(function(){
	$('#othersshow').css("background-color", "#D5BAD9");
	}, function(){
	$('#othersshow').css("background-color", "white");
});

var newsfeed = function() {
	var xhr;
	if(window.XMLHttpRequest) {
		xhr = new XMLHttpRequest();
	}
	else {
		xhr = new ActiveXObject("Microsoft.XMLHTTP");
	}		
	xhr.open("GET","/newsfeed",true);
	xhr.send();
	xhr.onreadystatechange = function() {
		if(xhr.readyState==4) 
		{
			$('#newsfeedboard').empty();
			var updates = JSON.parse(xhr.responseText);
			
			var i;
			for(i in updates) {
				
				//Parse the Json response, use replace function in case 1 string in
				//has multiple lines and break the parser
				var update = JSON.parse(JSON.parse(updates[i]).replace(/\n/g,""));
				//alert(update);
				
		        //Get the time
				var currentTime = new Date().getTime();
				var storyTime = update.date;
				var deltaTime = currentTime - storyTime;
				var deltaSeconds = Math.trunc(deltaTime/1000);
				
				//Create link to user
				var userlink = document.createElement("a");
				userlink.setAttribute('href','#');
				userlink.textContent = update.updaterName + ' (' 
						+ deltaSeconds + ' seconds ago)';
				//alert(userlink.textContent);
				
				//Build canvas tag
				var canvas = buildCanvas(update.nTitle,update.nContent);
		        
				//Create <a> tag and attach the canvas into it
				var link = document.createElement("a");
				link.setAttribute('href','/blog/' + update.blogId + '/post/' + update.postId);
				
				link.appendChild(canvas);
				
				//Put all childs together
				document.getElementById("newsfeedboard").appendChild(userlink);
				$("#newsfeedboard").append("<br></br>");
				document.getElementById("newsfeedboard").appendChild(link);
				$("#newsfeedboard").append("<br></br>");
				$("#newsfeedboard").append("<br></br>");				
			}	
		}
	}
};

//Function to build a canvas element, need to be separated from newsFeed()
function buildCanvas(cTitle,cContent) {
	var canvas = document.createElement('canvas');
	canvas.setAttribute("style","border:1px solid black;");
	canvas.setAttribute("width","720");
	canvas.setAttribute("height","320");
	var canvasContext = canvas.getContext('2d');
	var data = '<svg xmlns="http://www.w3.org/2000/svg" width="720" height="320">' +
       '<foreignObject width="100%" height="100%">' +
       '<div xmlns="http://www.w3.org/1999/xhtml" style="font-size:20px">' + 
       '<h5>' + cTitle + '</h5>' + cContent 
       + '</div>' + '</foreignObject>' + '</svg>';
   	var DOMURL = window.URL || window.webkitURL || window;
    var img = new Image();
    var svg = new Blob([data], {type: 'image/svg+xml;charset=utf-8'});
    var url = DOMURL.createObjectURL(svg);
    img.onload = function () {
    canvasContext.drawImage(img, 0, 0);
    	DOMURL.revokeObjectURL(url);
    };
    img.src = url;
    return canvas;
}
</script>